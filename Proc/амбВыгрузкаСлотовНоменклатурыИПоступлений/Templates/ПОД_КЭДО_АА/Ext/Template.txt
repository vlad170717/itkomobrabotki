<ПравилаОбмена>
	<ВерсияФормата РежимСовместимости="РежимСовместимостиСБСП20">2.01</ВерсияФормата>
	<Ид>8158d517-3457-40e0-af9a-cfd3a37db176    </Ид>
	<Наименование>КлиентЭДОБазовая 2.9 --&gt; Автосалон5.1.23</Наименование>
	<ДатаВремяСоздания>2022-10-27T16:19:37</ДатаВремяСоздания>
	<Источник ВерсияПлатформы="8.0" ВерсияКонфигурации="2.9.4.31" СинонимКонфигурации="Клиент ЭДО (базовая), редакция 2.9">КлиентЭДОБазовая</Источник>
	<Приемник ВерсияПлатформы="8.0" ВерсияКонфигурации="5.1.23.04" СинонимКонфигурации="Альфа-Авто: Автосалон+Автосервис+Автозапчасти ПРОФ, редакция 5.1">Автосалон5</Приемник>
	<ПослеЗагрузкиПравилОбмена>
ВерсияПравил	= "//#%#091#%%#";
ВерсияПравил	= СтрЗаменить(ВерсияПравил, "//#%#","");
ВерсияПравил	= СтрЗаменить(ВерсияПравил, "#%%#","");
Сообщить("Версия правил " + ВерсияПравил);
</ПослеЗагрузкиПравилОбмена>
	<ПослеЗагрузкиПараметров>Параметры.ПодразделениеИП = Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000005");
Параметры.ПодразделениеООО = Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000008");</ПослеЗагрузкиПараметров>
	<Параметры>
		<Параметр Имя="ВыгрузитьВсеПоступленияЗаПериод                   " Наименование="Выгрузить все поступления - не смотрим на статус ТребуетсяУтверждение документа ВхЭДО" ИспользуетсяПриЗагрузке="true" УстанавливатьВДиалоге="true" ТипЗначения="Булево" ПередаватьПараметрПриВыгрузке="true"/>
		<Параметр Имя="ПодразделениеИП                                   " Наименование="ПодразделениеИП                                   " ИспользуетсяПриЗагрузке="true" УстанавливатьВДиалоге="true" ТипЗначения="Строка" ПередаватьПараметрПриВыгрузке="true"/>
		<Параметр Имя="ПодразделениеООО                                  " Наименование="ПодразделениеООО                                  " ИспользуетсяПриЗагрузке="true" УстанавливатьВДиалоге="true" ТипЗначения="Строка" ПередаватьПараметрПриВыгрузке="true"/>
	</Параметры>
	<Обработки/>
	<ПравилаКонвертацииОбъектов>
		<Группа>
			<Код>Документы</Код>
			<Наименование>Документы</Наименование>
			<Порядок>50</Порядок>
			<Правило>
				<Код>ПоступлениеТоваров</Код>
				<Наименование>Документ: Поступление (акты, накладные)</Наименование>
				<Порядок>50</Порядок>
				<ПередВыгрузкой>Отказ = НЕ (СокрЛП(Источник.Организация.ИНН) = "781005610160" ИЛИ СокрЛП(Источник.Организация.ИНН) = "7810729740");

Запрос = Новый Запрос;
Запрос.Текст =  
"ВЫБРАТЬ
|	ПоступлениеТоваровУслугТовары.НаименованиеПоставщика КАК НаименованиеПоставщика,
|	ПоступлениеТоваровУслугТовары.Номенклатура КАК Номенклатура,
|	ПоступлениеТоваровУслугТовары.Характеристика КАК Характеристика,
|	ПоступлениеТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
|	ПоступлениеТоваровУслугТовары.Количество КАК Количество,
|	ПоступлениеТоваровУслугТовары.Цена КАК Цена,
|	ПоступлениеТоваровУслугТовары.Сумма КАК Сумма,
|	ПоступлениеТоваровУслугТовары.СтавкаНДС КАК СтавкаНДС,
|	ПоступлениеТоваровУслугТовары.СуммаНДС КАК СуммаНДС,
|	ПоступлениеТоваровУслугТовары.НомерГТД КАК НомерГТД,
|	ПоступлениеТоваровУслугТовары.СтранаПроисхождения КАК СтранаПроисхождения,
|	ПоступлениеТоваровУслугТовары.ИдентификаторСтроки КАК ИдентификаторСтроки
|ПОМЕСТИТЬ ВТ_Товары
|ИЗ
|	Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары
|ГДЕ
|	ПоступлениеТоваровУслугТовары.Ссылка = &amp;Ссылка
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	ВТ_Товары.НаименованиеПоставщика КАК НаименованиеПоставщика,
|	ВТ_Товары.Номенклатура КАК Номенклатура,
|	ВТ_Товары.Характеристика КАК Характеристика,
|	ЕСТЬNULL(ЕдиницыИзмерения.Код, """") КАК КодЕдиницыИзмеренияПоКлассификатору,
|	ВТ_Товары.Количество КАК Количество,
|	ВТ_Товары.Цена КАК Цена,
|	ВТ_Товары.Сумма КАК Сумма,
|	ВТ_Товары.СтавкаНДС КАК СтавкаНДС,
|	ВТ_Товары.СуммаНДС КАК СуммаНДС,
|	ВТ_Товары.НомерГТД КАК НомерГТД,
|	ВТ_Товары.СтранаПроисхождения КАК СтранаПроисхождения,
|	ЕСТЬNULL(ВидыНоменклатуры.ТипНоменклатуры, """") КАК ТипНоменклатуры,
|	ВТ_Товары.ИдентификаторСтроки КАК ИдентификаторСтроки
|ПОМЕСТИТЬ ВТ_ТоварыВидыНоменклатуры
|ИЗ
|	ВТ_Товары КАК ВТ_Товары
|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК ТаблицаНоменклатуры
|		ПО ВТ_Товары.Номенклатура = ТаблицаНоменклатуры.Ссылка
|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыНоменклатуры КАК ВидыНоменклатуры
|		ПО (ТаблицаНоменклатуры.ВидНоменклатуры = ВидыНоменклатуры.Ссылка)
|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЕдиницыИзмерения КАК ЕдиницыИзмерения
|		ПО ВТ_Товары.ЕдиницаИзмерения = ЕдиницыИзмерения.Ссылка
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	ВТ_ТоварыВидыНоменклатуры.НаименованиеПоставщика КАК НаименованиеПоставщика,
|	ВТ_ТоварыВидыНоменклатуры.Номенклатура КАК Номенклатура,
|	ВТ_ТоварыВидыНоменклатуры.Характеристика КАК ХарактеристикаНоменклатуры,
|	ВТ_ТоварыВидыНоменклатуры.КодЕдиницыИзмеренияПоКлассификатору КАК КодЕдиницыИзмеренияПоКлассификатору,
|	ВТ_ТоварыВидыНоменклатуры.Количество КАК Количество,
|	ВТ_ТоварыВидыНоменклатуры.Количество КАК КоличествоБазовое,
|	ВТ_ТоварыВидыНоменклатуры.Цена КАК Цена,
|	ВТ_ТоварыВидыНоменклатуры.Сумма КАК Сумма,
|	ВТ_ТоварыВидыНоменклатуры.СтавкаНДС КАК СтавкаНДС,
|	ВТ_ТоварыВидыНоменклатуры.СуммаНДС КАК СуммаНДС,
|	ВТ_ТоварыВидыНоменклатуры.НомерГТД КАК НомерГТД,
|	ВТ_ТоварыВидыНоменклатуры.СтранаПроисхождения.Наименование КАК СтранаПроисхождения,
|	ВТ_ТоварыВидыНоменклатуры.ИдентификаторСтроки КАК ИдентификаторТовара
|ИЗ
|	ВТ_ТоварыВидыНоменклатуры КАК ВТ_ТоварыВидыНоменклатуры
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	ПоступлениеТоваровУслугКодыУпаковокМаркируемойПродукции.НомерУпаковки КАК КодМаркировки,
|	ПоступлениеТоваровУслугКодыУпаковокМаркируемойПродукции.ИдентификаторСтроки КАК ИдентификаторТовара
|ИЗ
|	Документ.ПоступлениеТоваровУслуг.КодыУпаковокМаркируемойПродукции КАК ПоступлениеТоваровУслугКодыУпаковокМаркируемойПродукции
|ГДЕ
|	ПоступлениеТоваровУслугКодыУпаковокМаркируемойПродукции.Ссылка = &amp;Ссылка";
Запрос.УстановитьПараметр("Ссылка", Источник.Ссылка);

РезультатыЗапроса = Запрос.ВыполнитьПакет();

ВходящиеДанные = Новый Структура;
ВходящиеДанные.Вставить("Товары", РезультатыЗапроса[2].Выгрузить());</ПередВыгрузкой>
				<ПослеЗагрузки>Если НЕ ЗначениеЗаполнено(Объект.Автор) Тогда
	Объект.Автор = ПараметрыСеанса.Пользователь;
КонецЕсли;

амбООО = Объект.Организация.ФормаСобственности = Перечисления.ФормыСобственности.ЮридическоеЛицо;

Если амбООО Тогда
	Объект.ПодразделениеКомпании = Параметры.ПодразделениеООО;
	Объект.амбООО = Истина;
Иначе
	Объект.ПодразделениеКомпании = Параметры.ПодразделениеИП;
КонецЕсли;
Объект.ВалютаДокумента = Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();

Объект.ТипЦен = Справочники.ТипыЦен.ОсновнойТипЦенЗакупки;
Объект.ХозОперация = Справочники.ХозОперации.ПоступлениеТоваров;
Объект.ЗакрытиеЗаказовПоПодразделению = Перечисления.ВариантыОтветов.Нет;
Объект.ДоговорВзаиморасчетов = Справочники.Контрагенты.ПолучитьДоговорВзаиморасчетов(Объект.Контрагент, Перечисления.ВидыДоговоров.Покупка, Объект);

//--------------------------------------------------------
Если амбООО Тогда
	Выполнить(Алгоритмы.ЗаполнитьГТД);
КонецЕсли;



Объект.Проведен = Ложь;

ТипЦенВключаетНДС = Объект.ТипЦен.ЦенаВключаетНДС;

Запрос = Новый Запрос;
Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЕдиницыИзмерения.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.ЕдиницыИзмерения КАК ЕдиницыИзмерения
	|ГДЕ
	|	ЕдиницыИзмерения.Владелец = &amp;ТипНом
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЕдиницыИзмерения.Наименование УБЫВ";


Для Каждого ТекущаяСтрока Из Объект.Товары Цикл
	
	Если НЕ ЗначениеЗаполнено(ТекущаяСтрока.ИдентификаторТовара) Тогда
		ТекущаяСтрока.ИдентификаторТовара = Новый УникальныйИдентификатор;
	КонецЕсли;
	
	ТекущаяСтрока.СуммаВсего = ТекущаяСтрока.Сумма + ТекущаяСтрока.СуммаНДС;
	
	Если ТипЦенВключаетНДС Тогда
		ТекущаяСтрока.Сумма = ТекущаяСтрока.Сумма + ТекущаяСтрока.СуммаНДС;
		ТекущаяСтрока.Цена  = ?(ТекущаяСтрока.Количество = 0, 0, ТекущаяСтрока.Сумма / ТекущаяСтрока.Количество);
	КонецЕсли;
	
	Если НЕ амбООО Тогда
		ТекущаяСтрока.СуммаНДС = 0;
		ТекущаяСтрока.СтавкаНДС = Справочники.СтавкиНДС.БезНДС;
		ТекущаяСтрока.ГТД = Справочники.ГТД.ПустаяСсылка();
	КонецЕсли;

	Запрос.УстановитьПараметр("ТипНом", ТекущаяСтрока.Номенклатура.ТипНоменклатуры);
	
	Результат = Запрос.Выполнить();
	
	Выборка = Результат.Выбрать();
	
	Если Выборка.Следующий() Тогда
		ТекущаяСтрока.ЕдиницаИзмерения = Выборка.Ссылка;
	КонецЕсли;

	
КонецЦикла;

Если НЕ амбООО Тогда
	Объект.Товары.Свернуть("Номенклатура,ЕдиницаИзмерения,Коэффициент,СтавкаНДС, Цена","Количество,КоличествоБазовое,Сумма,СуммаВсего");
КонецЕсли;


</ПослеЗагрузки>
				<НеЗамещать>true</НеЗамещать>
				<Источник>ДокументСсылка.ПоступлениеТоваровУслуг</Источник>
				<Приемник>ДокументСсылка.ПоступлениеТоваров</Приемник>
				<Свойства>
					<Свойство Поиск="true">
						<Код>1</Код>
						<Наименование>Дата --&gt; Дата</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="Дата" Вид="Свойство" Тип="Дата"/>
						<Приемник Имя="Дата" Вид="Свойство" Тип="Дата"/>
					</Свойство>
					<Свойство>
						<Код>2</Код>
						<Наименование>ДокументОснование --&gt; ДокументОснование</Наименование>
						<Порядок>100</Порядок>
						<Источник Имя="ДокументОснование" Вид="Реквизит" Тип="ДокументСсылка.ПоступлениеТоваровУслуг"/>
						<Приемник Имя="ДокументОснование" Вид="Реквизит"/>
					</Свойство>
					<Свойство>
						<Код>3</Код>
						<Наименование>Комментарий --&gt; Комментарий</Наименование>
						<Порядок>150</Порядок>
						<Источник Имя="Комментарий" Вид="Реквизит" Тип="Строка"/>
						<Приемник Имя="Комментарий" Вид="Реквизит" Тип="Строка"/>
						<ПередВыгрузкой>Значение = "# сумма иэ ЭДО: " + Строка(Источник.СуммаДокумента);</ПередВыгрузкой>
					</Свойство>
					<Свойство>
						<Код>4</Код>
						<Наименование>Контрагент --&gt; Контрагент</Наименование>
						<Порядок>200</Порядок>
						<Источник Имя="Контрагент" Вид="Реквизит" Тип="СправочникСсылка.Контрагенты"/>
						<Приемник Имя="Контрагент" Вид="Реквизит" Тип="СправочникСсылка.Контрагенты"/>
						<КодПравилаКонвертации>Контрагенты                                       </КодПравилаКонвертации>
					</Свойство>
					<Свойство Поиск="true">
						<Код>5</Код>
						<Наименование>Номер --&gt; Номер</Наименование>
						<Порядок>250</Порядок>
						<Источник Имя="Номер" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Номер" Вид="Свойство" Тип="Строка"/>
						<ПриводитьКДлине>10</ПриводитьКДлине>
					</Свойство>
					<Свойство>
						<Код>6</Код>
						<Наименование>Организация --&gt; Организация</Наименование>
						<Порядок>300</Порядок>
						<Источник Имя="Организация" Вид="Реквизит" Тип="СправочникСсылка.Организации"/>
						<Приемник Имя="Организация" Вид="Реквизит" Тип="СправочникСсылка.Организации"/>
						<КодПравилаКонвертации>Организации                                       </КодПравилаКонвертации>
					</Свойство>
					<Свойство>
						<Код>7</Код>
						<Наименование>ПометкаУдаления --&gt; ПометкаУдаления</Наименование>
						<Порядок>350</Порядок>
						<Источник Имя="ПометкаУдаления" Вид="Свойство" Тип="Булево"/>
						<Приемник Имя="ПометкаУдаления" Вид="Свойство" Тип="Булево"/>
					</Свойство>
					<Свойство Отключить="true">
						<Код>8</Код>
						<Наименование>Проведен --&gt; Проведен</Наименование>
						<Порядок>400</Порядок>
						<Источник Имя="Проведен" Вид="Свойство" Тип="Булево"/>
						<Приемник Имя="Проведен" Вид="Свойство" Тип="Булево"/>
					</Свойство>
					<Свойство>
						<Код>9</Код>
						<Наименование>СуммаДокумента --&gt; СуммаДокумента</Наименование>
						<Порядок>450</Порядок>
						<Источник Имя="СуммаДокумента" Вид="Реквизит" Тип="Число"/>
						<Приемник Имя="СуммаДокумента" Вид="Реквизит" Тип="Число"/>
					</Свойство>
					<Группа>
						<Код>10</Код>
						<Наименование>--&gt; Товары</Наименование>
						<Порядок>500</Порядок>
						<ПолучитьИзВходящихДанных>true</ПолучитьИзВходящихДанных>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="Товары" Вид="ТабличнаяЧасть"/>
						<Свойство>
							<Код>12</Код>
							<Наименование>--&gt; Количество</Наименование>
							<Порядок>100</Порядок>
							<Источник Имя="" Вид=""/>
							<Приемник Имя="Количество" Вид="Реквизит" Тип="Число"/>
						</Свойство>
						<Свойство>
							<Код>13</Код>
							<Наименование>--&gt; Номенклатура</Наименование>
							<Порядок>150</Порядок>
							<Источник Имя="" Вид=""/>
							<Приемник Имя="Номенклатура" Вид="Реквизит" Тип="СправочникСсылка.Номенклатура"/>
							<КодПравилаКонвертации>Номенклатура                                      </КодПравилаКонвертации>
							<ПередВыгрузкой>Значение = ОбъектКоллекции.Номенклатура;</ПередВыгрузкой>
						</Свойство>
						<Свойство>
							<Код>14</Код>
							<Наименование>--&gt; СтавкаНДС</Наименование>
							<Порядок>200</Порядок>
							<Источник Имя="" Вид=""/>
							<Приемник Имя="СтавкаНДС" Вид="Реквизит" Тип="СправочникСсылка.СтавкиНДС"/>
							<ПередВыгрузкой>СтавкаНДС = Строка(ОбъектКоллекции.СтавкаНДС);
ИсходящиеДанные = Новый Структура;
ИсходящиеДанные.Вставить("Наименование", СтавкаНДС);</ПередВыгрузкой>
						</Свойство>
						<Свойство>
							<Код>15</Код>
							<Наименование>--&gt; Сумма</Наименование>
							<Порядок>250</Порядок>
							<Источник Имя="" Вид=""/>
							<Приемник Имя="Сумма" Вид="Реквизит" Тип="Число"/>
						</Свойство>
						<Свойство>
							<Код>16</Код>
							<Наименование>--&gt; СуммаНДС</Наименование>
							<Порядок>300</Порядок>
							<Источник Имя="" Вид=""/>
							<Приемник Имя="СуммаНДС" Вид="Реквизит" Тип="Число"/>
						</Свойство>
						<Свойство>
							<Код>17</Код>
							<Наименование>--&gt; Цена</Наименование>
							<Порядок>350</Порядок>
							<Источник Имя="" Вид=""/>
							<Приемник Имя="Цена" Вид="Реквизит" Тип="Число"/>
						</Свойство>
						<Свойство>
							<Код>25</Код>
							<Наименование>--&gt; КоличествоБазовое</Наименование>
							<Порядок>400</Порядок>
							<Источник Имя="" Вид=""/>
							<Приемник Имя="КоличествоБазовое" Вид="Реквизит" Тип="Число"/>
						</Свойство>
						<Свойство>
							<Код>26</Код>
							<Наименование>--&gt; КодЕдиницыИзмеренияПоКлассификатору</Наименование>
							<Порядок>450</Порядок>
							<Источник Имя="" Вид=""/>
							<Приемник Имя="" Вид=""/>
							<ИмяПараметраДляПередачи>КодЕдиницыИзмеренияПоКлассификатору</ИмяПараметраДляПередачи>
							<ПередВыгрузкой>Значение = ОбъектКоллекции.КодЕдиницыИзмеренияПоКлассификатору;</ПередВыгрузкой>
						</Свойство>
						<Свойство>
							<Код>27</Код>
							<Наименование>--&gt; НомерГТД</Наименование>
							<Порядок>500</Порядок>
							<Источник Имя="" Вид=""/>
							<Приемник Имя="" Вид=""/>
							<ИмяПараметраДляПередачи>НомерГТД</ИмяПараметраДляПередачи>
							<ПередВыгрузкой>Значение = ОбъектКоллекции.НомерГТД;</ПередВыгрузкой>
						</Свойство>
						<Свойство>
							<Код>28</Код>
							<Наименование>--&gt; СтранаПроисхождения</Наименование>
							<Порядок>550</Порядок>
							<Источник Имя="" Вид=""/>
							<Приемник Имя="" Вид=""/>
							<ИмяПараметраДляПередачи>СтранаПроисхождения</ИмяПараметраДляПередачи>
							<ПередВыгрузкой>Значение = ОбъектКоллекции.СтранаПроисхождения;</ПередВыгрузкой>
						</Свойство>
						<Свойство>
							<Код>29</Код>
							<Наименование>--&gt; ИдентификаторТовара</Наименование>
							<Порядок>600</Порядок>
							<Источник Имя="" Вид=""/>
							<Приемник Имя="ИдентификаторТовара" Вид="Реквизит" Тип="Строка"/>
						</Свойство>
						<Свойство>
							<Код>30</Код>
							<Наименование>--&gt; Коэффициент</Наименование>
							<Порядок>650</Порядок>
							<Источник Имя="" Вид=""/>
							<Приемник Имя="Коэффициент" Вид="Реквизит" Тип="Число"/>
							<ПередВыгрузкой>Значение = 1;</ПередВыгрузкой>
						</Свойство>
					</Группа>
					<Свойство>
						<Код>19</Код>
						<Наименование>--&gt; РегламентированныйУчет</Наименование>
						<Порядок>600</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="РегламентированныйУчет" Вид="Реквизит" Тип="Булево"/>
						<ПередВыгрузкой>Значение = Истина;</ПередВыгрузкой>
					</Свойство>
					<Свойство>
						<Код>20</Код>
						<Наименование>ДатаЭД --&gt; ВхДокДата</Наименование>
						<Порядок>650</Порядок>
						<Источник Имя="ДатаЭД" Вид="Реквизит" Тип="Дата"/>
						<Приемник Имя="ВхДокДата" Вид="Реквизит" Тип="Дата"/>
					</Свойство>
					<Свойство>
						<Код>21</Код>
						<Наименование>НомерЭД --&gt; ВхДокНомер</Наименование>
						<Порядок>700</Порядок>
						<Источник Имя="НомерЭД" Вид="Реквизит" Тип="Строка"/>
						<Приемник Имя="ВхДокНомер" Вид="Реквизит" Тип="Строка"/>
					</Свойство>
					<Свойство>
						<Код>22</Код>
						<Наименование>--&gt; КурсВалютыВзаиморасчетов</Наименование>
						<Порядок>750</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="КурсВалютыВзаиморасчетов" Вид="Реквизит" Тип="Число"/>
						<ПередВыгрузкой>Значение = 1;</ПередВыгрузкой>
					</Свойство>
					<Свойство>
						<Код>23</Код>
						<Наименование>--&gt; КурсДокумента</Наименование>
						<Порядок>800</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="КурсДокумента" Вид="Реквизит" Тип="Число"/>
						<ПередВыгрузкой>Значение = 1;</ПередВыгрузкой>
					</Свойство>
					<Свойство>
						<Код>24</Код>
						<Наименование>--&gt; КурсВалютыУпр</Наименование>
						<Порядок>850</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="КурсВалютыУпр" Вид="Реквизит" Тип="Число"/>
						<ПередВыгрузкой>Значение = 1;</ПередВыгрузкой>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
		</Группа>
		<Группа>
			<Код>Справочники</Код>
			<Наименование>Справочники</Наименование>
			<Порядок>100</Порядок>
			<Правило>
				<Код>Контрагенты</Код>
				<Наименование>Справочник: Контрагенты</Наименование>
				<Порядок>50</Порядок>
				<НеЗамещать>true</НеЗамещать>
				<НеСоздаватьЕслиНеНайден>true</НеСоздаватьЕслиНеНайден>
				<Источник>СправочникСсылка.Контрагенты</Источник>
				<Приемник>СправочникСсылка.Контрагенты</Приемник>
				<Свойства>
					<Свойство>
						<Код>1</Код>
						<Наименование>Код --&gt; Код</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<ПриводитьКДлине>8</ПриводитьКДлине>
					</Свойство>
					<Свойство>
						<Код>2</Код>
						<Наименование>Наименование --&gt; Наименование</Наименование>
						<Порядок>100</Порядок>
						<Источник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
					</Свойство>
					<Свойство>
						<Код>3</Код>
						<Наименование>Родитель --&gt; Родитель</Наименование>
						<Порядок>150</Порядок>
						<Источник Имя="Родитель" Вид="Свойство" Тип="СправочникСсылка.Контрагенты"/>
						<Приемник Имя="Родитель" Вид="Свойство" Тип="СправочникСсылка.Контрагенты"/>
						<КодПравилаКонвертации>Контрагенты                                       </КодПравилаКонвертации>
					</Свойство>
					<Свойство Поиск="true" Обязательное="true">
						<Код>4</Код>
						<Наименование>ЭтоГруппа --&gt; ЭтоГруппа</Наименование>
						<Порядок>200</Порядок>
						<Источник Имя="ЭтоГруппа" Вид="Свойство" Тип="Булево"/>
						<Приемник Имя="ЭтоГруппа" Вид="Свойство" Тип="Булево"/>
					</Свойство>
					<Свойство Поиск="true">
						<Код>5</Код>
						<Наименование>ИНН --&gt; ИНН</Наименование>
						<Порядок>250</Порядок>
						<Источник Имя="ИНН" Вид="Реквизит" Тип="Строка"/>
						<Приемник Имя="ИНН" Вид="Реквизит" Тип="Строка"/>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
			<Правило>
				<Код>Организации</Код>
				<Наименование>Справочник: Организации</Наименование>
				<Порядок>100</Порядок>
				<НеЗамещать>true</НеЗамещать>
				<НеСоздаватьЕслиНеНайден>true</НеСоздаватьЕслиНеНайден>
				<Источник>СправочникСсылка.Организации</Источник>
				<Приемник>СправочникСсылка.Организации</Приемник>
				<Свойства>
					<Свойство>
						<Код>1</Код>
						<Наименование>Код --&gt; Код</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<ПриводитьКДлине>8</ПриводитьКДлине>
					</Свойство>
					<Свойство>
						<Код>2</Код>
						<Наименование>Наименование --&gt; Наименование</Наименование>
						<Порядок>100</Порядок>
						<Источник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
					</Свойство>
					<Свойство Поиск="true">
						<Код>3</Код>
						<Наименование>ИНН --&gt; ИНН</Наименование>
						<Порядок>150</Порядок>
						<Источник Имя="ИНН" Вид="Реквизит" Тип="Строка"/>
						<Приемник Имя="ИНН" Вид="Реквизит" Тип="Строка"/>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
			<Правило>
				<Код>ЕдиницыИзмерения</Код>
				<Наименование>Справочник: Единицы измерения</Наименование>
				<Порядок>150</Порядок>
				<НеЗамещать>true</НеЗамещать>
				<НеСоздаватьЕслиНеНайден>true</НеСоздаватьЕслиНеНайден>
				<Источник>СправочникСсылка.ЕдиницыИзмерения</Источник>
				<Приемник>СправочникСсылка.ЕдиницыИзмерения</Приемник>
				<Свойства>
					<Свойство Поиск="true">
						<Код>1</Код>
						<Наименование>Код --&gt; Код</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Код" Вид="Свойство" Тип="Строка"/>
					</Свойство>
					<Свойство>
						<Код>2</Код>
						<Наименование>Наименование --&gt; Наименование</Наименование>
						<Порядок>100</Порядок>
						<Источник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
					</Свойство>
					<Свойство>
						<Код>3</Код>
						<Наименование>--&gt; Владелец</Наименование>
						<Порядок>150</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="Владелец" Вид="Свойство"/>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
			<Правило>
				<Код>Номенклатура</Код>
				<Наименование>Справочник: Номенклатура</Наименование>
				<Порядок>200</Порядок>
				<ПриЗагрузке>Если ОбъектНайден И 
	(Объект.амбСтатусСлота &lt;&gt; Перечисления.амбСтатусСлотаНоменклатуры.НовыйСлотИП И
	 Объект.амбСтатусСлота &lt;&gt; Перечисления.амбСтатусСлотаНоменклатуры.НовыйСлотАМ) Тогда

	 Сообщить("Не Замещаем");
	 НеЗамещатьОбъект = Истина;
Иначе
	 Сообщить("Замещаем " + Объект.Ссылка);
	 НеЗамещатьОбъект = Ложь;
	 Объект.амбСтатусСлота = Перечисления.амбСтатусСлотаНоменклатуры.ТребуетсяДоводка;
КонецЕсли;</ПриЗагрузке>
				<НеЗамещать>true</НеЗамещать>
				<НеСоздаватьЕслиНеНайден>true</НеСоздаватьЕслиНеНайден>
				<Источник>СправочникСсылка.Номенклатура</Источник>
				<Приемник>СправочникСсылка.Номенклатура</Приемник>
				<Свойства>
					<Свойство Поиск="true">
						<Код>1</Код>
						<Наименование>Код --&gt; Код</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<ПриводитьКДлине>8</ПриводитьКДлине>
					</Свойство>
					<Свойство>
						<Код>2</Код>
						<Наименование>Наименование --&gt; Наименование</Наименование>
						<Порядок>100</Порядок>
						<Источник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
					</Свойство>
					<Свойство Отключить="true">
						<Код>3</Код>
						<Наименование>Родитель --&gt; Родитель</Наименование>
						<Порядок>150</Порядок>
						<Источник Имя="Родитель" Вид="Свойство" Тип="СправочникСсылка.Номенклатура"/>
						<Приемник Имя="Родитель" Вид="Свойство" Тип="СправочникСсылка.Номенклатура"/>
						<КодПравилаКонвертации>Номенклатура                                      </КодПравилаКонвертации>
					</Свойство>
					<Свойство Поиск="true" Обязательное="true">
						<Код>4</Код>
						<Наименование>ЭтоГруппа --&gt; ЭтоГруппа</Наименование>
						<Порядок>200</Порядок>
						<Источник Имя="ЭтоГруппа" Вид="Свойство" Тип="Булево"/>
						<Приемник Имя="ЭтоГруппа" Вид="Свойство" Тип="Булево"/>
					</Свойство>
					<Свойство Отключить="true">
						<Код>5</Код>
						<Наименование>Артикул --&gt; Артикул</Наименование>
						<Порядок>250</Порядок>
						<Источник Имя="Артикул" Вид="Реквизит" Тип="Строка"/>
						<Приемник Имя="Артикул" Вид="Реквизит" Тип="Строка"/>
					</Свойство>
					<Свойство>
						<Код>6</Код>
						<Наименование>НаименованиеПолное --&gt; НаименованиеПолное</Наименование>
						<Порядок>300</Порядок>
						<Источник Имя="НаименованиеПолное" Вид="Реквизит" Тип="Строка"/>
						<Приемник Имя="НаименованиеПолное" Вид="Реквизит" Тип="Строка"/>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
		</Группа>
	</ПравилаКонвертацииОбъектов>
	<ПравилаВыгрузкиДанных>
		<Группа Отключить="false">
			<Код>Документы</Код>
			<Наименование>Документы</Наименование>
			<Порядок>50</Порядок>
			<Правило Отключить="false">
				<Код>ПоступлениеТоваровУслуг</Код>
				<Наименование>ПоступлениеТоваровУслуг</Наименование>
				<Порядок>50</Порядок>
				<СпособОтбораДанных>ПроизвольныйАлгоритм</СпособОтбораДанных>
				<ПередОбработкойПравила>	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент КАК ЭлектронныйДокумент,
		|	ОбъектыУчетаДокументовЭДО.ОбъектУчета КАК ОбъектУчета,
		|	ТИПЗНАЧЕНИЯ(ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент) КАК Поле1,
		|	ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент.Контрагент КАК ЭлектронныйДокументКонтрагент,
		|	СостоянияДокументовЭДО.Состояние КАК Состояние
		|ИЗ
		|	РегистрСведений.ОбъектыУчетаДокументовЭДО КАК ОбъектыУчетаДокументовЭДО
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.амб_ВыгружатьПоступленияВАльфу КАК амб_ВыгружатьПоступленияВАльфу
		|		ПО (ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент.Контрагент = амб_ВыгружатьПоступленияВАльфу.Контрагент)
		|			И (ТИПЗНАЧЕНИЯ(ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент) = ТИП(Документ.ЭлектронныйДокументВходящийЭДО))
		|			И (ТИПЗНАЧЕНИЯ(ОбъектыУчетаДокументовЭДО.ОбъектУчета) = ТИП(Документ.ПоступлениеТоваровУслуг))
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.СостоянияДокументовЭДО КАК СостоянияДокументовЭДО
		|		ПО (ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент = СостоянияДокументовЭДО.ЭлектронныйДокумент)
		|       И (СостоянияДокументовЭДО.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияДокументовЭДО.ТребуетсяУтверждение))
		|ГДЕ
		|	амб_ВыгружатьПоступленияВАльфу.ДатаНачала &lt; ОбъектыУчетаДокументовЭДО.ОбъектУчета.Дата
		|	И ОбъектыУчетаДокументовЭДО.ОбъектУчета.Дата МЕЖДУ &amp;ДатаНачала И &amp;ДатаОкончания";

	Если Параметры.ВыгрузитьВсеПоступленияЗаПериод Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И (СостоянияДокументовЭДО.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияДокументовЭДО.ТребуетсяУтверждение))", "");	
		//Сообщить(Запрос.Текст);
	КонецЕсли;	
	//Перечисление.СостоянияДокументовЭДО.ТребуетсяУтверждение
	//Перечисление.СостоянияДокументовЭДО.ОбменЗавершен
	Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(ДатаНачала));
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(ДатаОкончания)); 	
	
	Результат = Запрос.Выполнить();
	
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Сообщить(Выборка.ОбъектУчета);
		ВыгрузитьПоПравилу(Выборка.ОбъектУчета,,,,"ПоступлениеТоваров");
	КонецЦикла;
</ПередОбработкойПравила>
			</Правило>
		</Группа>
		<Группа Отключить="false">
			<Код>Справочники</Код>
			<Наименование>Справочники</Наименование>
			<Порядок>100</Порядок>
			<Правило Отключить="false">
				<Код>Номенклатура</Код>
				<Наименование>Номенклатура</Наименование>
				<Порядок>50</Порядок>
				<СпособОтбораДанных>ПроизвольныйАлгоритм</СпособОтбораДанных>
				<ПередОбработкойПравила>	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	НоменклатураДополнительныеРеквизиты.Ссылка КАК Номенклатура,
		|	НоменклатураДополнительныеРеквизиты.Ссылка.Код КАК Код
		|ИЗ
		|	Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.ДополнительныеРеквизитыИСведения КАК ДополнительныеРеквизитыИСведения
		|		ПО НоменклатураДополнительныеРеквизиты.Свойство = ДополнительныеРеквизитыИСведения.Ссылка
		|			И (ДополнительныеРеквизитыИСведения.Наименование = ""СтатусСлота"")
		|ГДЕ
		|	НоменклатураДополнительныеРеквизиты.Значение = ""СлотЗаполнен""";
	
	Результат = Запрос.Выполнить();
	
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Сообщить("Слот Заполнен: " + Выборка.Номенклатура + " " + Выборка.Код);
		ВыгрузитьПоПравилу(Выборка.Номенклатура,,,,"Номенклатура");
	КонецЦикла;
</ПередОбработкойПравила>
			</Правило>
		</Группа>
	</ПравилаВыгрузкиДанных>
	<ПравилаОчисткиДанных/>
	<Алгоритмы>
		<Алгоритм Имя="ЗаполнитьГТД" ИспользуетсяПриЗагрузке="true">
			<Текст>// для отладки
//ТаблицаТоваров = Новый ТаблицаЗначений;
//ТаблицаТоваров.Колонки.Добавить("НомерСтроки", Новый ОписаниеТипов("Число"));
//ТаблицаТоваров.Колонки.Добавить("Номенклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
//ТаблицаТоваров.Колонки.Добавить("КодЕдиницыИзмеренияПоКлассификатору", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(4)));
//ТаблицаТоваров.Колонки.Добавить("НомерГТД", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(200)));
//ТаблицаТоваров.Колонки.Добавить("СтранаПроисхождения", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(200)));
//ТаблицаТоваров.Колонки.Добавить("ГТД", Новый ОписаниеТипов("СправочникСсылка.ГТД"));

//НоваяСтрока = ТаблицаТоваров.Добавить();
//НоваяСтрока.НомерСтроки = 0;
//НоваяСтрока.Номенклатура = Справочники.Номенклатура.НайтиПоКоду("ЦБ081855");
//НоваяСтрока.КодЕдиницыИзмеренияПоКлассификатору = "796";
//НоваяСтрока.СтранаПроисхождения = Справочники.КлассификаторСтранМира.НайтиПоНаименованию("ИТАЛИЯ");
//НоваяСтрока.НомерГТД = "112606651/010819/0009118/2665";

//ПараметрыОбъекта = Новый Соответствие;
//ПараметрыОбъекта.Вставить("ТоварыТабличнаяЧасть", ТаблицаТоваров);

//Объект = Документы.ПоступлениеТоваров.СоздатьДокумент();
//Объект.Товары.Загрузить(ТаблицаТоваров);

ТаблицаПараметров = ?(ПараметрыОбъекта &lt;&gt; Неопределено, ПараметрыОбъекта.Получить("ТоварыТабличнаяЧасть"), ПараметрыОбъекта);

Если ТаблицаПараметров &lt;&gt; Неопределено Тогда
	Для каждого СтрокаПараметров Из ТаблицаПараметров Цикл
		СсылкаСтрана = Справочники.КлассификаторСтранМира.ПустаяСсылка();
		
		СтрокаТовары = Объект.Товары.Найти(СтрокаПараметров.НомерСтроки);
		Если СтрокаТовары = Неопределено Тогда
			Сообщить("Не нашли товар по номеру строки.");
			Продолжить;
		КонецЕсли; 
		
		ЗаданаСтрана = Ложь;
		Попытка
			СтранаТекст = СтрокаПараметров.СтранаПроисхождения;
			ЗаданаСтрана = Истина;	
		Исключение
		КонецПопытки;
		
		
		Если ЗаданаСтрана Тогда
			ЗапросСтрана = Новый Запрос;
			ЗапросСтрана.Текст = 
			"ВЫБРАТЬ
			|	КлассификаторСтранМира.Ссылка КАК Ссылка
			|ИЗ
			|	Справочник.КлассификаторСтранМира КАК КлассификаторСтранМира
			|ГДЕ
			|	КлассификаторСтранМира.Наименование = &amp;Наименование";
			
			
			ЗапросСтрана.УстановитьПараметр("Наименование", СтрокаПараметров.СтранаПроисхождения);
			
			Результат = ЗапросСтрана.Выполнить();
			
			ВыборкаСтрана = Результат.Выбрать();
			
			Если ВыборкаСтрана.Следующий() Тогда         
				СсылкаСтрана =  ВыборкаСтрана.Ссылка;
			КонецЕсли;
		КонецЕсли;
	
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	ГТД.Ссылка КАК Ссылка,
			|	ПРЕДСТАВЛЕНИЕ(ГТД.Страна) КАК Страна
			|ИЗ
			|	Справочник.ГТД КАК ГТД
			|ГДЕ
			|	ГТД.Страна = &amp;Страна
			|	И ГТД.Наименование = &amp;Наименование";
		
		Запрос.УстановитьПараметр("Наименование", СтрокаПараметров.НомерГТД);
		Запрос.УстановитьПараметр("Страна", СсылкаСтрана);
		
		РезультатГТД = Запрос.Выполнить();
		
		ВыборкаГТД = РезультатГТД.Выбрать();
		
		Если ВыборкаГТД.Следующий() Тогда
			СтрокаТовары.ГТД = ВыборкаГТД.Ссылка;
		Иначе
			ГТД = Справочники.ГТД.СоздатьЭлемент();
	 		ГТД.Наименование = СтрокаПараметров.НомерГТД;
	 		ГТД.Страна = СсылкаСтрана;
		 	ГТД.Записать();      
			Сообщить("Созадана ГТД: " + ГТД.Наименование + "[" + ГТД.Страна + "]");
			СтрокаТовары.ГТД = ГТД.Ссылка;
		КонецЕсли;
	КонецЦикла; 
КонецЕсли;
</Текст>
			<Параметры>Объект</Параметры>
		</Алгоритм>
		<Алгоритм Имя="ЗаполнитьЕдиницыИзмеренияГТД" ИспользуетсяПриЗагрузке="true">
			<Текст>ТаблицаПараметров = ?(ПараметрыОбъекта &lt;&gt; Неопределено, ПараметрыОбъекта.Получить("ТоварыТабличнаяЧасть"), ПараметрыОбъекта);

Если ТаблицаПараметров &lt;&gt; Неопределено Тогда
	
	ТаблицаЕдиницыИзмеренияГТД = Новый ТаблицаЗначений;
	ТаблицаЕдиницыИзмеренияГТД.Колонки.Добавить("НомерСтроки", Новый ОписаниеТипов("Число"));
	ТаблицаЕдиницыИзмеренияГТД.Колонки.Добавить("КодЕдиницыИзмеренияПоКлассификатору", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(4)));
	ТаблицаЕдиницыИзмеренияГТД.Колонки.Добавить("НомерГТД", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(200)));
	ТаблицаЕдиницыИзмеренияГТД.Колонки.Добавить("СтранаПроисхождения", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(200)));
	Для Каждого СтрокаПараметров Из ТаблицаПараметров Цикл
		НоваяСтрока = ТаблицаЕдиницыИзмеренияГТД.Добавить();
		НоваяСтрока.НомерСтроки = СтрокаПараметров.НомерСтроки + 1;
		НоваяСтрока.КодЕдиницыИзмеренияПоКлассификатору = СтрокаПараметров.КодЕдиницыИзмеренияПоКлассификатору;
		НоваяСтрока.СтранаПроисхождения = Справочники.КлассификаторСтранМира.НайтиПоНаименованию(СтрокаПараметров.СтранаПроисхождения);
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ТаблицаЕдиницыИзмерения.НомерСтроки КАК НомерСтроки,
		|	ТаблицаЕдиницыИзмерения.КодЕдиницыИзмеренияПоКлассификатору КАК КодЕдиницыИзмеренияПоКлассификатору,
		|	ТаблицаЕдиницыИзмерения.НомерГТД КАК НомерГТД
		|ПОМЕСТИТЬ ВТ_ЕдиницыИзмерения
		|ИЗ
		|	&amp;ТаблицаЕдиницыИзмерения КАК ТаблицаЕдиницыИзмерения
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТаблицаТовары.НомерСтроки КАК НомерСтроки,
		|	ТаблицаТовары.Номенклатура КАК Номенклатура
		|ПОМЕСТИТЬ ВТ_Товары
		|ИЗ
		|	&amp;ТаблицаТовары КАК ТаблицаТовары
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Товары.НомерСтроки КАК НомерСтроки,
		|	ВТ_Товары.Номенклатура КАК Номенклатура,
		|	ЕСТЬNULL(ЕдиницыИзмерения.Ссылка, Неопределено) КАК ЕдиницаИзмерения,
		|	ЕСТЬNULL(ЕдиницыИзмерения.Коэффициент, 0) КАК Коэффициент,
		|	ЕСТЬNULL(КлассификаторЕдиницИзмерения.Ссылка, Неопределено) КАК Классификатор
		|ИЗ
		|	ВТ_Товары КАК ВТ_Товары
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ЕдиницыИзмерения КАК ВТ_ЕдиницыИзмерения
		|		ПО ВТ_Товары.НомерСтроки = ВТ_ЕдиницыИзмерения.НомерСтроки
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлассификаторЕдиницИзмерения КАК КлассификаторЕдиницИзмерения
		|		ПО (ВТ_ЕдиницыИзмерения.КодЕдиницыИзмеренияПоКлассификатору = КлассификаторЕдиницИзмерения.Код)
		|			И (НЕ КлассификаторЕдиницИзмерения.ПометкаУдаления)
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЕдиницыИзмерения КАК ЕдиницыИзмерения
		|		ПО (ВТ_Товары.Номенклатура = ЕдиницыИзмерения.Владелец ИЛИ ВТ_Товары.Номенклатура.ТипНоменклатуры = ЕдиницыИзмерения.Владелец)
		|			И (КлассификаторЕдиницИзмерения.Ссылка = ЕдиницыИзмерения.ЕдиницаПоКлассификатору)
		|			И (НЕ ЕдиницыИзмерения.ПометкаУдаления)
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Товары.НомерСтроки КАК НомерСтроки,
		|	ВТ_Товары.Номенклатура КАК Номенклатура,
		|	ЕСТЬNULL(ГТД.Ссылка, Неопределено) КАК ГТД,
		|	ВТ_ЕдиницыИзмерения.НомерГТД КАК НомерГТД
		|ИЗ
		|	ВТ_Товары КАК ВТ_Товары
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ЕдиницыИзмерения КАК ВТ_ЕдиницыИзмерения
		|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ГТД КАК ГТД
		|			ПО (ВТ_ЕдиницыИзмерения.НомерГТД = ГТД.Наименование
		|					И НЕ ГТД.ПометкаУдаления)
		|		ПО ВТ_Товары.НомерСтроки = ВТ_ЕдиницыИзмерения.НомерСтроки";	
	Запрос.УстановитьПараметр("ТаблицаЕдиницыИзмерения", ТаблицаЕдиницыИзмеренияГТД);
	Запрос.УстановитьПараметр("ТаблицаТовары", Объект.Товары.Выгрузить(,"НомерСтроки, Номенклатура"));
	
	ПакетЗапрос = Запрос.ВыполнитьПакет();
	Выборка = ПакетЗапрос[2].Выбрать();
	
	Пока Выборка.СледующийПоЗначениюПоля("НомерСтроки") Цикл
		СтрокаТаблицы = Объект.Товары[Выборка.НомерСтроки - 1];
		Если ЗначениеЗаполнено(Выборка.ЕдиницаИзмерения) Тогда
			СтрокаТаблицы.ЕдиницаИзмерения = Выборка.ЕдиницаИзмерения;
			СтрокаТаблицы.Коэффициент      = Выборка.Коэффициент;
		ИначеЕсли ЗначениеЗаполнено(Выборка.Классификатор) Тогда
			//ЕдиницаИзмерения = ЕдиницаИзмеренияНоменклатуры(СтрокаТаблицы.Номенклатура, Выборка.Классификатор);
			ЕдиницаИзмерения = неопределено;
			// посмотрим как у нас хранятся единицы измерения
			Если СтрокаТаблицы.Номенклатура.ТипНоменклатуры.ИспользованиеЕдиницИзмерения=1 Тогда // подчинены типу номенклатуры
				ВладелецЕдиниц = СтрокаТаблицы.Номенклатура.ТипНоменклатуры;
			Иначе // подчинены номенклатуре
				ВладелецЕдиниц = СтрокаТаблицы.Номенклатура;
			КонецЕсли;
			
			Если НЕ ЗначениеЗаполнено(ВладелецЕдиниц) Тогда
				Продолжить;
			КонецЕсли;
			
			// ищем единицу
			Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
			|	ЕдиницыИзмерения.Ссылка,
			|	ЕдиницыИзмерения.Коэффициент КАК Коэффициент,
			|	ВЫБОР
			|		КОГДА ЕдиницыИзмерения.Наименование = &amp;ЕдиницаПоКлассификатору ТОГДА
			|			0
			|		ИНАЧЕ
			|			1
			|	КОНЕЦ КАК ПолеСортировки
			|ИЗ
			|	Справочник.ЕдиницыИзмерения КАК ЕдиницыИзмерения
			|ГДЕ
			|	ЕдиницыИзмерения.Владелец = &amp;ВладелецЕдиниц И 
			|	ЕдиницыИзмерения.ПометкаУдаления = ЛОЖЬ И 
			|	ЕдиницыИзмерения.ЕдиницаПоКлассификатору = &amp;БазоваяЕдиницаИзмерения
			|УПОРЯДОЧИТЬ ПО
			|	Коэффициент ВОЗР,
			|	ПолеСортировки ВОЗР
			|");
			
			Запрос.УстановитьПараметр("ВладелецЕдиниц",          ВладелецЕдиниц);
			Запрос.УстановитьПараметр("БазоваяЕдиницаИзмерения", Выборка.Классификатор);
			Запрос.УстановитьПараметр("ЕдиницаПоКлассификатору", Выборка.Классификатор.Наименование);
			Выборка = Запрос.Выполнить().Выбрать();
			// если нашли, то вернем единицу, иначе создадим новую
			Если Выборка.Следующий() Тогда
				ЕдиницаИзмерения = Выборка.Ссылка;
			Иначе
				// не нашли - создаем новую
				НоваяЕдиница=Справочники.ЕдиницыИзмерения.СоздатьЭлемент();
				НоваяЕдиница.Владелец=ВладелецЕдиниц;
				НоваяЕдиница.УстановитьНовыйКод("");
				НоваяЕдиница.ЕдиницаПоКлассификатору=Выборка.Классификатор;
				НоваяЕдиница.Коэффициент=1;
				НоваяЕдиница.Точность=2;
				НоваяЕдиница.Наименование=СокрЛП(Выборка.Классификатор);
				// ++ Alexku 02.02.2016
				Если СтрокаТаблицы.Номенклатура.ТипНоменклатуры.ИспользованиеЕдиницИзмерения = 2 Тогда
					// подчинены номенклатуре
					// перенесем вес и объем из карточки номенклатуры в основную единицу измерения
					НоваяЕдиница.Вес = СтрокаТаблицы.Номенклатура.Вес;
					НоваяЕдиница.Объем = СтрокаТаблицы.Номенклатура.Объем;
					ЭтотОбъект.Вес = 0;
					ЭтотОбъект.Объем = 0;
				КонецЕсли;
				// -- Alexku 
				НоваяЕдиница.Записать();
				ЕдиницаИзмерения = НоваяЕдиница.Ссылка;
			КонецЕсли;
			
			СтрокаТаблицы.ЕдиницаИзмерения = ЕдиницаИзмерения;
			СтрокаТаблицы.Коэффициент      = ЕдиницаИзмерения.Коэффициент;
		Иначе
			СтрокаТаблицы.ЕдиницаИзмерения = СтрокаТаблицы.Номенклатура.ОсновнаяЕдиницаИзмерения;
			СтрокаТаблицы.Коэффициент = СтрокаТаблицы.Номенклатура.ОсновнаяЕдиницаИзмерения.Коэффициент;
		КонецЕсли;
	КонецЦикла;
	
	Выборка = ПакетЗапрос[3].Выбрать();
	
	Пока Выборка.СледующийПоЗначениюПоля("НомерСтроки") Цикл
		СтрокаТаблицы = Объект.Товары[Выборка.НомерСтроки - 1];
		Если ЗначениеЗаполнено(Выборка.ГТД) Тогда
			СтрокаТаблицы.ГТД = Выборка.ГТД;
		ИначеЕсли ЗначениеЗаполнено(Выборка.НомерГТД) Тогда
			//ГТД = Справочники.ГТД.СоздатьЭлемент();
			//ГТД.Наименование = Выборка.НомерГТД;
			//ГТД.Записать();
			//СтрокаТаблицы.ГТД = ГТД;
		КонецЕсли;
	КонецЦикла;	
	
КонецЕсли;</Текст>
			<Параметры>Объект</Параметры>
		</Алгоритм>
	</Алгоритмы>
	<Запросы/>
</ПравилаОбмена>